
{% extends "base.html" %}
{% block content %}
<h1>Telescope Control</h1>

    <!-- combo to select tracking rates -->
    <!-- selections come from telescope itself -->
    <fieldset>
        <legend>Test Command String function</legend>
        <form hx-post="/send_command"
              hx-target="#response"
              hx-swap="innerHTML">
            <label for="command">Enter Command String:</label>
            <input type="text" id="command" name="command">
            <br>
            Response: <textarea name="response" id="response">Response will come here</textarea>
            <input type="submit" value="Send Command"> 
        </form>
    </fieldset>
    <br>

    <!-- tracking rates using buttons -->

    <fieldset>
        <legend>Push button to set tracking rate</legend>
        <div class="tr-button-container">
            {% for tr in tracking_rates %}
                <button class="tr-control-button" onclick="toggle_tr_button(this, {{tr.value}})">{{tr.name}}</button>
            {% endfor %}
        </div>
    </fieldset>
    
    <fieldset>
        <legend>Control Tracking</legend>
        <form hx-post="/update_tracking">
            <label for="tracking-enable">Enable / Disable Tracking:</label>
            <input type="checkbox" id="tracking-enable" name="tracking-enable"
                 value="1" {% if tracking %}checked{% endif %}>
            <br>
            <label for="tracking-rate">Select Tracking Rate:</label>
            <!-- checkbox to enable tracking -->
            <select name="tracking-rate" id="tracking-rate">
                {% for tr in tracking_rates %}
                    <option value={{ tr.value }} 
                    {% if tr.value == current_tracking_rate %}selected{% endif %}>{{ tr.name }} </option>
                {% endfor %}
            </select>
            <br>
            <input type="submit" value="Change Tracking">
        </form>
    </fieldset>

    <fieldset>
        <legend>Control MoveAxis (Slewing) Speed</legend>
        <form hx-post="/update_moveaxis_rate">
            <label for="moveaxis_rate">Select MoveAxis Speed:</label>
            <select name="moveaxis_rate" id="moveaxis_rate">
                {% for rate in moveaxis_rates %}
                    <option value={{ rate.number }} {% if rate.number == selected_rate %} selected {% endif %}>
                        {{ rate.name }} = {{ rate.rate }} </option>
                {% endfor %}
            </select>
            <br>
            <input type="submit" value="Set MoveAxis/Slewing Speed">
        </form>
    </fieldset>

    <div class="controller" id="controller">
        <!-- row 1 -->
        <div></div>
        <button class="control-btn" id="up-btn">UP</button>
        <div></div>

        <!-- row 2 -->
        <button class="control-btn" id="left-btn"> LEFT
            <!-- old HTMX approach tried:
            hx-post="/control" 
            hx-trigger="pointerdown, pointerup from:body" 
            hx-vals='js:{"direction":"LEFT", "event_type":(event.type==="pointerdown")?"start":"end"}'
            -->
        </button>
        <button class="control-btn" id="stop-btn">STOP</button>
        <button class="control-btn" id="right-btn">RIGHT</button>

        <!-- row three -->    
        <div></div>
        <button class="control-btn" id="down-btn">DOWN</button>
        <div></div>
    </div>

    <div hx-get="/status" hx-trigger="every 1s" hx-target="#status-table" hx-swap="outerHTML">
        {% include "telescope_coords.html" %}
    </div>

<script>
    // htmx.logAll()
    // set up the event handlers for all the control buttons
    document.querySelectorAll('.control-btn').forEach(button => {
        
        // Add event listener for pointerdown
        button.addEventListener('pointerdown', function (event) {
            // Capture the pointer for this button
            button.setPointerCapture(event.pointerId);
            sendPointerEvent(button.id, 'start');
        });
        
        // Add event listener for pointerup
        button.addEventListener('pointerup', function (event) {
            // Release the pointer capture for this button
            button.releasePointerCapture(event.pointerId);
            sendPointerEvent(button.id, 'end');
        });
    });

    // old code was: "direction":"LEFT", "event_type":(event.type==="pointerdown")?"start":"end"
    // Function to send POST request to Flask server
    function sendPointerEvent(buttonName, eventType) {
        fetch('/control', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                button_name: buttonName,
                event_type: eventType
            })
        })
        .then(response => response.json())
        .then(data => console.log('Data received from /control post:', data))
        .catch((error) => {
            console.error('Error after /control post: ', error);
        });
    }

    // Function to toggle tracking rate buttons and update server
    function toggle_tr_button(button, tr_value) {
        // tr_value is the number for the tracking rate list
        
        // Disable the button interaction while waiting for the POST response
        disableButtons(true);

        // Send the POST request (to special JSON endpoint)
        fetch('/update_tracking_json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'tracking-rate': tr_value }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); // Assuming the server responds with JSON
        })
        .then(data => {
            if (data.success) {
                // Success: Update the button display
                const buttons = document.querySelectorAll('.tr-control-button');
                buttons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            } else {
                alert('Failed to update on the server');
            }
        })
        .catch(error => {
            alert('Failed to send the tracking rate update: ' + error.message);
        })
        .finally(() => {
            // Re-enable button interaction after the POST completes
            disableButtons(false);
        });
    }

    function disableButtons(disabled) {
        const buttons = document.querySelectorAll('.control-button');
        buttons.forEach(button => {
            if (disabled) {
                button.classList.add('disabled');
                button.disabled = true;
            } else {
                button.classList.remove('disabled');
                button.disabled = false;
            }
        });
    }
</script>

{% endblock %}

